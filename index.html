<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profkingkeys Q&A Tutorial</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://js.puter.com/v2/"></script>
<style>
/* ... (Styles remain exactly the same as before) ... */
:root{
  --bg:#08090d;--bg2:#0e1018;--panel:#111420;--panel2:#161924;
  --border:#1e2235;--border2:#252a3d;
  --gold:#f0b429;--gold2:#ffd166;--gold3:#c88400;
  --blue:#4d9eff;--green:#22d37a;--red:#ff4d4d;--purple:#c084fc;
  --cyan:#06d6d6;--orange:#ff8500;
  --white:#f0f2ff;--text:#9aa5c4;--muted:#4a5270;
  --obj:#4d9eff;--sub:#22d37a;--thy:#c084fc;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;}
body{overflow-x:hidden;}

/* SCREENS */
.screen{display:none;min-height:100vh;flex-direction:column;}
.screen.active{display:flex;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPLOAD SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#uploadScreen{
  align-items:center;justify-content:center;padding:24px;
  background:
    radial-gradient(ellipse 70% 50% at 50% -5%, rgba(77,158,255,0.08),transparent 55%),
    radial-gradient(ellipse 40% 40% at 90% 80%, rgba(192,132,252,0.06),transparent 55%),var(--bg);
}
.upload-box{width:100%;max-width:680px;}
.upload-crown{font-size:64px;text-align:center;margin-bottom:12px;animation:float 4s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
.upload-title{
  font-size:clamp(22px,4vw,38px);font-weight:800;text-align:center;
  background:linear-gradient(120deg,var(--gold2),var(--gold),var(--gold3));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:6px;line-height:1.2;
}
.upload-sub{text-align:center;color:var(--muted);font-size:13px;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:28px;}

.input-area{
  background:var(--panel);border:2px solid var(--border);border-radius:18px;
  padding:20px;margin-bottom:16px;
}
.input-area label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px;}
textarea#bookInput{
  width:100%;min-height:220px;background:var(--bg2);border:1px solid var(--border2);
  border-radius:12px;padding:16px;
  font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--white);
  resize:vertical;outline:none;line-height:1.7;
  transition:border-color 0.2s;
}
textarea#bookInput:focus{border-color:var(--blue);}
textarea#bookInput::placeholder{color:var(--muted);}

.char-count {
    text-align: right;
    font-size: 11px;
    color: var(--muted);
    margin-top: 5px;
    font-family: 'JetBrains Mono', monospace;
}

.options-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.option-chip{
  flex:1;min-width:140px;padding:14px 16px;background:var(--panel);
  border:2px solid var(--border);border-radius:14px;cursor:pointer;transition:all 0.15s;text-align:center;
}
.option-chip:hover{border-color:var(--blue);}
.option-chip.sel{border-color:var(--gold);background:rgba(240,180,41,0.07);}
.option-chip h4{font-size:13px;font-weight:700;color:var(--white);margin-bottom:4px;}
.option-chip p{font-size:11px;color:var(--muted);}

.btn-generate{
  width:100%;padding:18px;border-radius:14px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--gold3),var(--gold),var(--gold2));
  color:#0a0800;font-family:'Sora',sans-serif;font-size:15px;font-weight:800;
  letter-spacing:0.05em;text-transform:uppercase;
  box-shadow:0 4px 30px rgba(240,180,41,0.3);
  transition:all 0.2s;
  margin-bottom: 10px;
}
.btn-generate:hover{transform:translateY(-2px);box-shadow:0 8px 40px rgba(240,180,41,0.5);}
.btn-generate:disabled{opacity:0.4;cursor:not-allowed;transform:none;}

.btn-demo {
    width: 100%; padding: 12px; border-radius: 12px; border: 1px dashed var(--border2);
    background: transparent; color: var(--muted); font-size: 12px; cursor: pointer;
}
.btn-demo:hover { color: var(--white); border-color: var(--white); }

.status-box{
  margin-top:14px;padding:14px 18px;border-radius:12px;
  background:var(--panel);border:1px solid var(--border);
  font-size:13px;display:none;
}
.status-box.show{display:block;}
.status-box.error{border-color:var(--red);color:var(--red);}
.status-box.success{border-color:var(--green);color:var(--green);}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border2);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRAINING SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#trainingScreen{background:var(--bg);}
.topbar{
  background:var(--panel);border-bottom:1px solid var(--border);
  padding:0 20px;height:56px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:50;
}
.topbar-title{font-size:14px;font-weight:700;color:var(--gold);white-space:nowrap;}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.badge{padding:5px 12px;border-radius:20px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:0.06em;}
.badge-mode{background:rgba(192,132,252,0.12);color:var(--purple);border:1px solid rgba(192,132,252,0.25);}
.badge-prog{background:rgba(77,158,255,0.1);color:var(--blue);border:1px solid rgba(77,158,255,0.2);}

.training-main{flex:1;max-width:760px;margin:0 auto;padding:32px 20px;width:100%;}
.training-header{text-align:center;margin-bottom:28px;}
.training-header h2{font-size:24px;font-weight:800;color:var(--white);margin-bottom:8px;}
.training-header p{color:var(--muted);font-size:14px;line-height:1.6;}

.training-card{
  background:var(--panel);border:1px solid var(--border);border-radius:20px;
  padding:28px;margin-bottom:16px;position:relative;overflow:hidden;
}
.training-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,currentColor,transparent);opacity:0.5;}
.training-card.obj{color:var(--obj);}
.training-card.sub{color:var(--sub);}
.training-card.thy{color:var(--thy);}
.type-badge{
  display:inline-block;padding:4px 12px;border-radius:20px;
  font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  margin-bottom:14px;
}
.type-badge.obj{background:rgba(77,158,255,0.12);color:var(--obj);border:1px solid rgba(77,158,255,0.25);}
.type-badge.sub{background:rgba(34,211,122,0.12);color:var(--sub);border:1px solid rgba(34,211,122,0.25);}
.type-badge.thy{background:rgba(192,132,252,0.12);color:var(--thy);border:1px solid rgba(192,132,252,0.25);}
.q-num{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px;}
.q-text{font-size:16px;font-weight:600;color:var(--white);line-height:1.6;margin-bottom:16px;}
.answer-reveal{
  background:var(--bg2);border:1px solid var(--border2);border-radius:12px;
  padding:14px 16px;margin-top:10px;
}
.answer-reveal h4{font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;}
.answer-reveal p{font-size:14px;color:var(--white);line-height:1.7;}
.answer-reveal .options-list{margin-top:8px;}
.answer-reveal .opt-item{padding:6px 10px;border-radius:8px;font-size:13px;margin-bottom:4px;}
.answer-reveal .opt-item.correct{background:rgba(34,211,122,0.12);color:var(--green);font-weight:600;}
.answer-reveal .opt-item.other{color:var(--muted);}

.speak-btn{
  background:transparent;border:1px solid var(--border2);color:var(--muted);
  padding:6px 14px;border-radius:8px;cursor:pointer;font-size:11px;font-weight:600;
  transition:all 0.15s;margin-top:10px;
}
.speak-btn:hover{border-color:var(--cyan);color:var(--cyan);}
.speak-btn.active{border-color:var(--cyan);color:var(--cyan);background:rgba(6,214,214,0.1);}

.training-nav{
  display:flex;gap:10px;justify-content:center;margin-top:24px;flex-wrap:wrap;
}
.btn-nav{
  padding:12px 28px;border-radius:10px;border:none;cursor:pointer;
  font-family:'Sora',sans-serif;font-size:13px;font-weight:700;transition:all 0.15s;
}
.btn-prev{background:var(--panel);border:1px solid var(--border);color:var(--text);}
.btn-prev:hover{border-color:var(--blue);color:var(--blue);}
.btn-next-tr{background:var(--blue);color:#fff;}
.btn-next-tr:hover{background:#3d8df0;}
.btn-autoplay{background:var(--panel);border:1px solid var(--border);color:var(--purple);}
.btn-autoplay.active{background:rgba(192,132,252,0.1);border-color:var(--purple);}

.start-quiz-wrap{
  background:linear-gradient(135deg,rgba(240,180,41,0.08),rgba(192,132,252,0.05));
  border:1px solid rgba(240,180,41,0.2);border-radius:20px;
  padding:32px;text-align:center;margin-top:20px;
}
.start-quiz-wrap h3{font-size:22px;font-weight:800;color:var(--gold);margin-bottom:8px;}
.start-quiz-wrap p{color:var(--muted);font-size:14px;margin-bottom:20px;}
.btn-start-quiz{
  padding:16px 48px;border-radius:12px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--gold3),var(--gold));
  color:#0a0800;font-family:'Sora',sans-serif;font-size:15px;font-weight:800;
  letter-spacing:0.05em;text-transform:uppercase;transition:all 0.2s;
}
.btn-start-quiz:hover{transform:translateY(-2px);box-shadow:0 6px 35px rgba(240,180,41,0.4);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUIZ SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#quizScreen{background:var(--bg);}
.quiz-main{flex:1;max-width:760px;margin:0 auto;padding:32px 20px;width:100%;}
.quiz-card{
  background:var(--panel);border:1px solid var(--border);border-radius:20px;
  padding:28px;margin-bottom:16px;position:relative;overflow:hidden;
}
.quiz-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,currentColor,transparent);opacity:0.5;}
.quiz-card.obj{color:var(--obj);}
.quiz-card.sub{color:var(--sub);}
.quiz-card.thy{color:var(--thy);}

.opt-btn{
  width:100%;padding:14px 18px;background:var(--bg2);border:2px solid var(--border2);
  border-radius:12px;margin-bottom:10px;cursor:pointer;
  font-family:'Sora',sans-serif;font-size:14px;color:var(--white);
  display:flex;align-items:center;gap:12px;transition:all 0.15s;text-align:left;
}
.opt-btn:hover:not(:disabled){border-color:var(--blue);transform:translateX(4px);}
.opt-btn .opt-letter{
  width:28px;height:28px;border-radius:50%;background:var(--panel2);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:12px;flex-shrink:0;
}
.opt-btn.correct{background:rgba(34,211,122,0.12);border-color:var(--green);}
.opt-btn.correct .opt-letter{background:var(--green);color:#000;}
.opt-btn.wrong{background:rgba(255,77,77,0.12);border-color:var(--red);}
.opt-btn.wrong .opt-letter{background:var(--red);color:#fff;}

.fill-input{
  width:100%;padding:14px 16px;background:var(--bg2);border:2px solid var(--border2);
  border-radius:12px;font-family:'Sora',sans-serif;font-size:15px;color:var(--white);
  outline:none;transition:all 0.2s;margin-bottom:14px;
}
.fill-input:focus{border-color:var(--blue);}
.fill-input.correct{border-color:var(--green);background:rgba(34,211,122,0.08);}
.fill-input.wrong{border-color:var(--red);background:rgba(255,77,77,0.08);}

.theory-textarea{
  width:100%;min-height:140px;padding:14px 16px;background:var(--bg2);
  border:2px solid var(--border2);border-radius:12px;
  font-family:'Sora',sans-serif;font-size:14px;color:var(--white);
  resize:vertical;outline:none;line-height:1.7;transition:all 0.2s;margin-bottom:14px;
}
.theory-textarea:focus{border-color:var(--blue);}
.theory-textarea.good{border-color:var(--green);background:rgba(34,211,122,0.08);}
.theory-textarea.poor{border-color:var(--orange);background:rgba(255,133,0,0.08);}
.theory-textarea.wrong{border-color:var(--red);background:rgba(255,77,77,0.08);}

.btn-check{
  width:100%;padding:14px;background:var(--blue);color:#fff;border:none;
  border-radius:12px;cursor:pointer;font-family:'Sora',sans-serif;
  font-size:14px;font-weight:700;transition:all 0.15s;margin-bottom:10px;
}
.btn-check:hover{background:#3d8df0;}
.btn-check:disabled{opacity:0.4;cursor:not-allowed;}

.feedback-panel{
  background:var(--bg2);border:2px solid var(--border2);border-radius:12px;
  padding:16px;margin-top:16px;display:none;
}
.feedback-panel.show{display:block;}
.feedback-panel.correct{border-color:var(--green);background:rgba(34,211,122,0.05);}
.feedback-panel.wrong{border-color:var(--red);background:rgba(255,77,77,0.05);}
.feedback-panel.partial{border-color:var(--orange);background:rgba(255,133,0,0.05);}
.fb-title{font-size:15px;font-weight:700;color:var(--white);margin-bottom:8px;}
.fb-answer{font-size:14px;color:var(--text);line-height:1.7;margin-bottom:8px;}
.fb-keywords{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.kw-tag{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:600;}
.kw-tag.hit{background:rgba(34,211,122,0.15);color:var(--green);}
.kw-tag.miss{background:rgba(255,77,77,0.15);color:var(--red);}

.btn-next-q{
  width:100%;padding:14px;background:var(--gold);color:#000;border:none;
  border-radius:12px;cursor:pointer;font-family:'Sora',sans-serif;
  font-size:14px;font-weight:800;transition:all 0.15s;margin-top:14px;display:none;
}
.btn-next-q.show{display:block;}
.btn-next-q:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(240,180,41,0.4);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAGE COMPLETE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.stage-complete-overlay{
  position:fixed;inset:0;background:rgba(8,9,13,0.95);z-index:100;
  display:none;align-items:center;justify-content:center;padding:20px;
  backdrop-filter:blur(10px);
}
.stage-complete-overlay.show{display:flex;}
.stage-complete-box{
  background:var(--panel);border:2px solid var(--gold);border-radius:24px;
  padding:40px 32px;max-width:520px;width:100%;text-align:center;position:relative;
  box-shadow:0 20px 80px rgba(0,0,0,0.5);animation:scaleIn 0.4s cubic-bezier(.34,1.56,.64,1);
}
@keyframes scaleIn{from{transform:scale(0.8);opacity:0;}to{transform:scale(1);opacity:1;}}
.sc-trophy{font-size:72px;margin-bottom:16px;animation:bounce 2s ease-in-out infinite;}
@keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-12px);}}
.sc-title{font-size:28px;font-weight:800;color:var(--gold);margin-bottom:6px;}
.sc-sub{font-size:14px;color:var(--muted);margin-bottom:24px;}
.sc-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;}
.sc-stat{background:var(--bg2);border-radius:14px;padding:14px 8px;}
.sc-stat-num{font-size:26px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:4px;}
.sc-stat-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;}
.btn-sc-next{
  width:100%;padding:16px;background:linear-gradient(135deg,var(--gold3),var(--gold));
  color:#000;border:none;border-radius:12px;cursor:pointer;
  font-family:'Sora',sans-serif;font-size:15px;font-weight:800;
  letter-spacing:0.05em;transition:all 0.2s;
}
.btn-sc-next:hover{transform:translateY(-2px);box-shadow:0 8px 40px rgba(240,180,41,0.5);}

.confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:99;}
</style>
</head>
<body>

<div class="screen active" id="uploadScreen">
  <div class="upload-box">
    <div class="upload-crown">üëë</div>
    <h1 class="upload-title">Profkingkeys Tutorial</h1>
    <p class="upload-sub">AI-Powered Q&A Training System</p>

    <div class="input-area">
      <label for="bookInput">üìö Paste Your Lecture Notes or Study Material</label>
      <textarea id="bookInput" oninput="updateCharCount()" placeholder="Paste your lecture notes, study material, or AI-generated questions here...

You can paste:
‚Ä¢ Raw lecture notes (any length, even 1500+ words)
‚Ä¢ AI-generated questions from any external tool
‚Ä¢ Study materials in any format

The system will intelligently parse and create interactive questions!"></textarea>
      <div class="char-count" id="charCount">0 characters</div>
    </div>

    <div class="options-row">
      <div class="option-chip sel" data-mode="training" onclick="selectMode(this)">
        <h4>üìñ Training Mode</h4>
        <p>Learn with questions & answers revealed</p>
      </div>
      <div class="option-chip" data-mode="quiz" onclick="selectMode(this)">
        <h4>üéØ Quiz Mode</h4>
        <p>Test yourself without answers</p>
      </div>
    </div>

    <button class="btn-generate" onclick="generateQuestions()">
      ‚ö° Generate Interactive Questions
    </button>
    
    <button class="btn-demo" onclick="loadDemoData()">
      üß™ Connection Failed? Click here to use Demo Data
    </button>

    <div class="status-box" id="statusBox"></div>
  </div>
</div>

<div class="screen" id="trainingScreen">
  <div class="topbar">
    <button class="btn-nav btn-prev" onclick="goHome()">‚åÇ Home</button>
    <div class="topbar-title">üìñ Profkingkeys Training</div>
    <div class="topbar-right">
      <div class="badge badge-mode" id="modeTypeBadge">Training Mode</div>
      <div class="badge badge-prog" id="progBadge">Question 1/100</div>
    </div>
  </div>

  <div class="training-main">
    <div class="training-header">
      <h2 id="stageTitle">Stage 1: Objective Questions</h2>
      <p id="stageDesc">Multiple choice questions with single correct answers</p>
    </div>
    <div id="trainingQuestionContainer"></div>
    <div class="training-nav">
      <button class="btn-nav btn-prev" onclick="prevQuestion()" id="prevTrBtn">‚Üê Previous</button>
      <button class="btn-nav btn-autoplay" onclick="toggleAutoPlay()" id="autoPlayBtn">üîÑ Auto-Play: OFF</button>
      <button class="btn-nav btn-next-tr" onclick="nextQuestion()" id="nextTrBtn">Next ‚Üí</button>
    </div>
    <div class="start-quiz-wrap">
      <h3>üèÜ Ready to Test Your Knowledge?</h3>
      <p>You've reviewed all training questions. Time to prove what you've learned!</p>
      <button class="btn-start-quiz" onclick="startQuiz()">Start Quiz Mode ‚Üí</button>
    </div>
  </div>
</div>

<div class="screen" id="quizScreen">
  <div class="topbar">
    <button class="btn-nav btn-prev" onclick="goHome()">‚åÇ Home</button>
    <div class="topbar-title">üéØ Profkingkeys Quiz</div>
    <div class="topbar-right">
      <div class="badge badge-mode">Quiz Mode</div>
      <div class="badge badge-prog" id="quizProgBadge">Question 1/100</div>
    </div>
  </div>

  <div class="quiz-main">
    <div class="training-header">
      <h2 id="quizStageTitle">Stage 1: Objective Questions</h2>
      <p id="quizStageDesc">Choose the correct answer for each question</p>
    </div>
    <div id="quizQuestionContainer"></div>
  </div>
</div>

<div class="stage-complete-overlay" id="stageCompleteOverlay">
  <div class="stage-complete-box">
    <div class="sc-trophy">üèÜ</div>
    <h2 class="sc-title" id="scTitle">Stage 1 Complete!</h2>
    <p class="sc-sub" id="scSub">Moving to Stage 2 next!</p>
    <div class="sc-stats" id="scStats"></div>
    <button class="btn-sc-next" id="scNextBtn" onclick="nextStage()">STAGE 2 ‚Üí</button>
  </div>
</div>

<canvas class="confetti-canvas" id="confettiCanvas"></canvas>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedMode = 'training';
let allQuestions = {objective:[], subjective:[], theory:[]};
let stageQuestions = [];
let stageIndex = 0;
let qIndex = 0;
let stageCorrect = 0;
let totalCorrect = 0;
let autoPlayInterval = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   MODE SELECTION & UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectMode(el) {
  document.querySelectorAll('.option-chip').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
  selectedMode = el.dataset.mode;
}

function updateCharCount() {
    const len = document.getElementById('bookInput').value.length;
    document.getElementById('charCount').textContent = `${len} characters`;
}

function goHome() {
  speechSynthesis.cancel();
  clearInterval(autoPlayInterval);
  autoPlayInterval = null;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('uploadScreen').classList.add('active');
  document.getElementById('statusBox').classList.remove('show','error','success');
  // Don't clear input so user can edit if they want
  allQuestions = {objective:[], subjective:[], theory:[]};
  stageIndex = 0;
  qIndex = 0;
  stageCorrect = 0;
  totalCorrect = 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   ROBUST AI PARSING ENGINE (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateQuestions() {
  const rawInput = document.getElementById('bookInput').value.trim();
  const statusBox = document.getElementById('statusBox');
  
  if (!rawInput) {
    statusBox.className = 'status-box show error';
    statusBox.textContent = '‚ùå Please paste your study material or questions first.';
    return;
  }

  // Sanitizer
  const cleanInput = rawInput
    .replace(/\r\n/g, '\n')     
    .replace(/\t/g, ' ')        
    .replace(/ {2,}/g, ' ')     
    .slice(0, 100000);          

  statusBox.className = 'status-box show';
  statusBox.innerHTML = '<span class="spinner"></span> Connecting to AI...';
  document.querySelector('.btn-generate').disabled = true;

  try {
    // 1. Authenticate first (Fixes connection failed issues)
    if (!puter.auth.isSignedIn()) {
       await puter.auth.signIn();
    }
    
    statusBox.innerHTML = '<span class="spinner"></span> Processing text...';

    // 2. Call Puter AI Chat
    const prompt = `You are an expert educational content generator. Analyze the text below and generate a comprehensive quiz.
    
    The text is lecture notes or study material. Create 3 types of questions:
    1. OBJECTIVE (Multiple Choice - 4 options)
    2. SUBJECTIVE (Fill-in-the-blank / Short Answer)
    3. THEORY (Essay / Explanation)

    Output Format (Strictly follow this):
    
    OBJECTIVE:
    Q1: [Question]?
    A) [Option]
    B) [Option]
    C) [Option]
    D) [Option]
    Answer: [A/B/C/D]
    Explanation: [Brief reason]

    SUBJECTIVE:
    Q1: [Question]?
    Answer: [Correct Answer]

    THEORY:
    Q1: [Question]?
    Answer: [Detailed model answer]
    Keywords: [Key, Words, List]

    Rules:
    - Generate at least 5-10 questions per category based on the text length.
    
    Input Text:
    ${cleanInput}`;

    const response = await puter.ai.chat(prompt, { model: 'claude-3-5-sonnet' });
    
    const aiText = typeof response === 'string' ? response : response.message.content;

    const parsed = parseAIResponse(aiText);
    
    if (!parsed.objective.length && !parsed.subjective.length && !parsed.theory.length) {
      throw new Error('AI output empty.');
    }

    allQuestions = parsed;
    
    statusBox.className = 'status-box show success';
    statusBox.textContent = `‚úÖ Success! Generated ${parsed.objective.length} Objective, ${parsed.subjective.length} Subjective, and ${parsed.theory.length} Theory questions.`;
    
    setTimeout(() => {
      if (selectedMode === 'training') startTraining();
      else startQuiz();
      document.querySelector('.btn-generate').disabled = false;
    }, 1500);

  } catch (error) {
    console.error('Generation error:', error);
    statusBox.className = 'status-box show error';
    statusBox.innerHTML = `‚ùå Error: ${error.message}<br><br><small>If you are running this locally, you must use a local server (like Live Server in VS Code) or click "Use Demo Data" below.</small>`;
    document.querySelector('.btn-generate').disabled = false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   DEMO DATA (FALLBACK)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadDemoData() {
    allQuestions = {
        objective: [
            { question: "What is the primary function of mitochondria?", options: ["Energy production", "Protein synthesis", "DNA storage", "Cell division"], correct: "Energy production", explanation: "Mitochondria are the powerhouse of the cell." },
            { question: "Which gas do plants absorb during photosynthesis?", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Helium"], correct: "Carbon Dioxide", explanation: "Plants use CO2 to create glucose." }
        ],
        subjective: [
            { question: "The process by which plants make their own food is called?", answer: "Photosynthesis" }
        ],
        theory: [
            { question: "Explain the process of osmosis.", answer: "Osmosis is the movement of water molecules from a region of higher concentration to lower concentration through a semi-permeable membrane.", keywords: ["water", "concentration", "membrane", "movement"] }
        ]
    };
    if (selectedMode === 'training') startTraining();
    else startQuiz();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   ENHANCED PARSING LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseAIResponse(text) {
  const result = {objective: [], subjective: [], theory: []};
  text = text.replace(/\*\*/g, '').replace(/###/g, ''); 

  const sections = {
    objective: extractSection(text, 'OBJECTIVE'),
    subjective: extractSection(text, 'SUBJECTIVE'),
    theory: extractSection(text, 'THEORY')
  };

  if (sections.objective) result.objective = parseObjectiveQuestions(sections.objective);
  if (sections.subjective) result.subjective = parseSubjectiveQuestions(sections.subjective);
  if (sections.theory) result.theory = parseTheoryQuestions(sections.theory);

  return result;
}

function extractSection(text, sectionName) {
  const regex = new RegExp(`${sectionName}[:\\s]*\\n([\\s\\S]*?)(?=\\n(?:OBJECTIVE|SUBJECTIVE|THEORY)[:\\s]*\\n|$)`, 'i');
  const match = text.match(regex);
  return match ? match[1].trim() : '';
}

function parseObjectiveQuestions(section) {
  const questions = [];
  const questionBlocks = section.split(/Q\d+[:.]/i).filter(b => b.trim().length > 10);
  
  questionBlocks.forEach(block => {
    try {
      const lines = block.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length < 4) return;
      
      const questionText = lines[0].replace(/^[.:\s]+/, '');
      const options = [];
      let answer = '';
      let explanation = '';
      
      lines.forEach(line => {
        if (/^[A-D][\)\.]/i.test(line)) options.push(line.replace(/^[A-D][\)\.]\s*/i, ''));
        else if (/^Answer[:\s]/i.test(line)) answer = line.replace(/^Answer[:\s]+/i, '').trim().charAt(0).toUpperCase();
        else if (/^Explanation[:\s]/i.test(line)) explanation = line.replace(/^Explanation[:\s]+/i, '').trim();
      });
      
      if (options.length >= 2 && answer) {
        questions.push({
          question: questionText,
          options: options,
          correct: options[answer.charCodeAt(0) - 65] || options[0], 
          explanation: explanation || 'Correct!'
        });
      }
    } catch (e) { console.warn('Obj parse error', e); }
  });
  return questions;
}

function parseSubjectiveQuestions(section) {
  const questions = [];
  const questionBlocks = section.split(/Q\d+[:.]/i).filter(b => b.trim().length > 10);
  questionBlocks.forEach(block => {
    const lines = block.split('\n').map(l => l.trim()).filter(l => l);
    if(lines.length < 2) return;
    let answer = '';
    lines.forEach(l => { if(/^Answer[:\s]/i.test(l)) answer = l.replace(/^Answer[:\s]+/i, ''); });
    if(answer) questions.push({ question: lines[0], answer: answer });
  });
  return questions;
}

function parseTheoryQuestions(section) {
  const questions = [];
  const questionBlocks = section.split(/Q\d+[:.]/i).filter(b => b.trim().length > 10);
  questionBlocks.forEach(block => {
    const lines = block.split('\n').map(l => l.trim()).filter(l => l);
    if(lines.length < 2) return;
    let answer = '';
    let keywords = [];
    lines.forEach(l => {
      if(/^Answer[:\s]/i.test(l)) answer = l.replace(/^Answer[:\s]+/i, '');
      if(/^Keywords[:\s]/i.test(l)) keywords = l.replace(/^Keywords[:\s]+/i, '').split(/[,;]/).map(k=>k.trim());
    });
    if(answer) questions.push({ question: lines[0], answer: answer, keywords: keywords });
  });
  return questions;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   TRAINING MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTraining() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('trainingScreen').classList.add('active');
  stageIndex = 0;
  qIndex = 0;
  totalCorrect = 0;
  loadStage();
}

function loadStage() {
  const stages = [
    {name:'Objective', desc:'Multiple choice questions with single correct answers', questions:allQuestions.objective, type:'obj'},
    {name:'Subjective', desc:'Fill-in-the-blank and short answer questions', questions:allQuestions.subjective, type:'sub'},
    {name:'Theory', desc:'Essay questions requiring detailed explanations', questions:allQuestions.theory, type:'thy'}
  ];
  
  while(stageIndex < stages.length && stages[stageIndex].questions.length === 0) {
      stageIndex++;
  }
  
  if(stageIndex >= stages.length) {
      alert("No questions available in any category.");
      goHome();
      return;
  }

  const stage = stages[stageIndex];
  stageQuestions = stage.questions;
  qIndex = 0;
  stageCorrect = 0;
  
  document.getElementById('stageTitle').textContent = `Stage ${stageIndex+1}: ${stage.name} Questions`;
  document.getElementById('stageDesc').textContent = stage.desc;
  document.getElementById('modeTypeBadge').textContent = 'Training Mode';
  
  renderTrainingQuestion();
}

function renderTrainingQuestion() {
  if (qIndex >= stageQuestions.length) {
    document.getElementById('trainingQuestionContainer').innerHTML = '';
    document.querySelectorAll('.training-nav .btn-nav').forEach(b => b.style.display = 'none');
    document.querySelector('.start-quiz-wrap').style.display = 'block';
    return;
  }

  document.querySelectorAll('.training-nav .btn-nav').forEach(b => b.style.display = 'inline-block');
  document.querySelector('.start-quiz-wrap').style.display = 'none';
  
  const q = stageQuestions[qIndex];
  const container = document.getElementById('trainingQuestionContainer');
  document.getElementById('progBadge').textContent = `Question ${qIndex+1}/${stageQuestions.length}`;
  
  let typeClass = 'obj';
  if (stageIndex === 1) typeClass = 'sub';
  if (stageIndex === 2) typeClass = 'thy';
  
  let bodyHTML = '';
  
  if (stageIndex === 0) { 
    bodyHTML = q.options.map((opt,i) => 
      `<div class="opt-item ${opt === q.correct ? 'correct' : 'other'}">${String.fromCharCode(65+i)}) ${opt}</div>`
    ).join('');
    bodyHTML = `<div class="options-list">${bodyHTML}</div>`;
  } else if (stageIndex === 1) { 
    bodyHTML = `<div class="fill-input" style="background:var(--bg2);cursor:default;">${q.answer}</div>`;
  } else { 
    bodyHTML = `<div class="theory-textarea" style="cursor:default;resize:none;">${q.answer}</div>`;
    if (q.keywords && q.keywords.length > 0) {
      bodyHTML += `<div class="fb-keywords">${q.keywords.map(k => `<span class="kw-tag hit">‚úì ${k}</span>`).join('')}</div>`;
    }
  }
  
  container.innerHTML = `
    <div class="training-card ${typeClass}">
      <div class="type-badge ${typeClass}">${stageIndex === 0 ? 'OBJECTIVE' : stageIndex === 1 ? 'SUBJECTIVE' : 'THEORY'}</div>
      <div class="q-num">Question ${qIndex+1} of ${stageQuestions.length}</div>
      <div class="q-text">${q.question}</div>
      <div class="answer-reveal">
        <h4>‚úÖ Answer:</h4>
        ${bodyHTML}
        ${stageIndex === 0 && q.explanation ? `<p style="margin-top:12px;color:var(--muted);">${q.explanation}</p>` : ''}
      </div>
      <button class="speak-btn" onclick="speak('${escapeAttr(q.question + '. The answer is ' + (q.answer || q.correct))}')">üîä Speak</button>
    </div>
  `;
  speak(q.question);
}

function prevQuestion() {
  speechSynthesis.cancel();
  if (qIndex > 0) {
    qIndex--;
    renderTrainingQuestion();
  }
}

function nextQuestion() {
  speechSynthesis.cancel();
  qIndex++;
  renderTrainingQuestion(); 
}

function toggleAutoPlay() {
  const btn = document.getElementById('autoPlayBtn');
  if (autoPlayInterval) {
    clearInterval(autoPlayInterval);
    autoPlayInterval = null;
    btn.textContent = 'üîÑ Auto-Play: OFF';
    btn.classList.remove('active');
  } else {
    autoPlayInterval = setInterval(() => {
      nextQuestion();
      if (qIndex >= stageQuestions.length) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
        btn.textContent = 'üîÑ Auto-Play: OFF';
        btn.classList.remove('active');
      }
    }, 8000);
    btn.textContent = '‚è∏Ô∏è Auto-Play: ON';
    btn.classList.add('active');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   QUIZ MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startQuiz() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('quizScreen').classList.add('active');
  stageIndex = 0;
  qIndex = 0;
  stageCorrect = 0;
  totalCorrect = 0;
  loadQuizStage();
}

function loadQuizStage() {
  const stages = [
    {name:'Objective', desc:'Choose the correct answer for each question', questions:allQuestions.objective, type:'obj'},
    {name:'Subjective', desc:'Type the correct answer', questions:allQuestions.subjective, type:'sub'},
    {name:'Theory', desc:'Write detailed answers', questions:allQuestions.theory, type:'thy'}
  ];
  
  while(stageIndex < stages.length && stages[stageIndex].questions.length === 0) {
      stageIndex++;
  }
  
  if(stageIndex >= stages.length) {
      showStageComplete(); 
      return;
  }

  const stage = stages[stageIndex];
  stageQuestions = stage.questions;
  qIndex = 0;
  stageCorrect = 0;
  
  document.getElementById('quizStageTitle').textContent = `Stage ${stageIndex+1}: ${stage.name} Questions`;
  document.getElementById('quizStageDesc').textContent = stage.desc;
  
  renderQuestion();
}

function renderQuestion() {
  if (qIndex >= stageQuestions.length) {
    showStageComplete();
    return;
  }

  const q = stageQuestions[qIndex];
  const container = document.getElementById('quizQuestionContainer');
  document.getElementById('quizProgBadge').textContent = `Question ${qIndex+1}/${stageQuestions.length}`;
  
  let typeClass = 'obj';
  if (stageIndex === 1) typeClass = 'sub';
  if (stageIndex === 2) typeClass = 'thy';
  
  let bodyHTML = '';
  
  if (stageIndex === 0) { 
    bodyHTML = q.options.map((opt,i) => 
      `<button class="opt-btn" onclick="checkObjective(this, '${escapeAttr(opt)}', '${escapeAttr(q.correct)}', '${escapeAttr(q.explanation||'')}')">
        <div class="opt-letter">${String.fromCharCode(65+i)}</div>
        <span>${opt}</span>
      </button>`
    ).join('');
  } else if (stageIndex === 1) { 
    bodyHTML = `
      <input type="text" class="fill-input" id="fillInput" placeholder="Type your answer here...">
      <button class="btn-check" id="checkSubjBtn" onclick="checkSubjective()">‚úì Check Answer</button>
    `;
  } else { 
    bodyHTML = `
      <textarea class="theory-textarea" id="theoryInput" placeholder="Write your detailed answer here..."></textarea>
      <button class="btn-check" id="checkThyBtn" onclick="checkTheory()">‚úì Check Answer</button>
    `;
  }
  
  container.innerHTML = `
    <div class="quiz-card ${typeClass}">
      <div class="type-badge ${typeClass}">${stageIndex === 0 ? 'OBJECTIVE' : stageIndex === 1 ? 'SUBJECTIVE' : 'THEORY'}</div>
      <div class="q-num">Question ${qIndex+1} of ${stageQuestions.length}</div>
      <div class="q-text">${q.question}</div>
      ${bodyHTML}
      <div class="feedback-panel" id="feedbackPanel">
        <div class="fb-title" id="fbTitle"></div>
        <div class="fb-answer" id="fbAnswer"></div>
        <div class="fb-keywords" id="fbKeywords"></div>
      </div>
      <button class="btn-next-q" id="nextQBtn" onclick="nextQuestion()">Next Question ‚Üí</button>
    </div>
  `;
  speak(q.question);
}

function escapeAttr(str) {
  return (str||'').replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/\n/g,' ');
}

function checkObjective(btn, chosen, correct, explanation) {
  const allBtns = document.querySelectorAll('.opt-btn');
  allBtns.forEach(b => {
    b.disabled = true;
    const bText = b.querySelector('span').textContent;
    if (bText === correct) b.classList.add('correct');
    else if (b === btn && chosen !== correct) b.classList.add('wrong');
  });
  const isCorrect = chosen === correct;
  if (isCorrect) stageCorrect++;
  showFeedback(isCorrect ? 'correct' : 'wrong',
    isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect',
    isCorrect ? `"${correct}" is right! ${explanation}` : `The correct answer is: "${correct}". ${explanation}`
  );
  speak(isCorrect ? `Correct! ${explanation}` : `The correct answer is ${correct}. ${explanation}`);
  document.getElementById('nextQBtn').classList.add('show');
}

function checkSubjective() {
  const input = document.getElementById('fillInput');
  const checkBtn = document.getElementById('checkSubjBtn');
  if (checkBtn) checkBtn.disabled = true;
  const q = stageQuestions[qIndex];
  const typed = input.value.trim().toLowerCase();
  const correct = q.answer.toLowerCase();
  const isCorrect = typed === correct || (correct.length > 5 && correct.includes(typed) && typed.length > 3);
  input.className = 'fill-input ' + (isCorrect ? 'correct' : 'wrong');
  if (isCorrect) stageCorrect++;
  showFeedback(isCorrect ? 'correct' : 'wrong',
    isCorrect ? '‚úÖ Correct!' : '‚ùå The answer is:',
    isCorrect ? `"${q.answer}" ‚Äî well done!` : `"${q.answer}"`
  );
  speak(isCorrect ? `Correct! The answer is ${q.answer}` : `Incorrect. The correct answer is ${q.answer}`);
  document.getElementById('nextQBtn').classList.add('show');
}

function checkTheory() {
  const ta = document.getElementById('theoryInput');
  const checkBtn = document.getElementById('checkThyBtn');
  if (checkBtn) checkBtn.disabled = true;
  const q = stageQuestions[qIndex];
  const typed = ta.value.toLowerCase();
  
  let keywords = q.keywords;
  if(!keywords || keywords.length === 0) keywords = extractKeywords(q.answer);
  
  const hitKws = keywords.filter(kw => typed.includes(kw.toLowerCase()));
  const missKws = keywords.filter(kw => !typed.includes(kw.toLowerCase()));
  
  const score = hitKws.length / Math.max(keywords.length, 1);
  let cls, title;
  if (score >= 0.5) { cls='correct'; title='‚úÖ Good answer!'; stageCorrect++; }
  else if (score >= 0.2) { cls='partial'; title='‚ö†Ô∏è Partially correct'; }
  else { cls='wrong'; title='‚ùå Key points missed'; }
  
  ta.className = 'theory-textarea ' + (cls === 'correct' ? 'good' : cls === 'partial' ? 'poor' : 'wrong');

  const kwHTML = [
    ...hitKws.map(k=>`<span class="kw-tag hit">‚úì ${k}</span>`),
    ...missKws.map(k=>`<span class="kw-tag miss">‚úó ${k}</span>`)
  ].join('');

  showFeedback(cls, title, `Model answer: ${q.answer}`, kwHTML);
  speak(cls === 'correct' ? `Good answer!` : `The model answer involves: ${keywords.join(', ')}`);
  document.getElementById('nextQBtn').classList.add('show');
}

function extractKeywords(text) {
  const stopWords = new Set(['the','a','an','is','are','was','were','have','has','and','or','but','not','in','on','at','to','for','with']);
  return [...new Set(text.toLowerCase().match(/\b[a-z]{4,}\b/g)||[])]
    .filter(w => !stopWords.has(w)).slice(0,6);
}

function showFeedback(cls, title, answer, kwHTML='') {
  const panel = document.getElementById('feedbackPanel');
  panel.className = 'feedback-panel show ' + cls;
  document.getElementById('fbTitle').textContent = title;
  document.getElementById('fbAnswer').textContent = answer;
  document.getElementById('fbKeywords').innerHTML = kwHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   STAGE COMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showStageComplete() {
  totalCorrect += stageCorrect;
  const pct = stageQuestions.length > 0 ? Math.round((stageCorrect / stageQuestions.length) * 100) : 0;
  const wrong = stageQuestions.length - stageCorrect;
  
  document.getElementById('scTitle').textContent = `Stage ${stageIndex+1} Complete!`;
  document.getElementById('scSub').textContent =
    stageIndex < 2
      ? `Moving to Stage ${stageIndex+2} next!`
      : 'üèÜ All Stages Complete! You are a Profkingkeys Master!';
      
  document.getElementById('scStats').innerHTML = `
    <div class="sc-stat"><div class="sc-stat-num" style="color:var(--green)">${stageCorrect}</div><div class="sc-stat-label">Correct</div></div>
    <div class="sc-stat"><div class="sc-stat-num" style="color:var(--red)">${wrong}</div><div class="sc-stat-label">Wrong</div></div>
    <div class="sc-stat"><div class="sc-stat-num" style="color:var(--gold)">${pct}%</div><div class="sc-stat-label">Score</div></div>
    <div class="sc-stat"><div class="sc-stat-num" style="color:var(--blue)">${totalCorrect}</div><div class="sc-stat-label">Total Correct</div></div>
  `;
  
  const nextBtn = document.getElementById('scNextBtn');
  if (stageIndex >= 2) {
    nextBtn.textContent = '‚åÇ Home';
    nextBtn.onclick = goHome;
  } else {
    nextBtn.textContent = `STAGE ${stageIndex+2} ‚Üí`;
    nextBtn.onclick = nextStage;
  }
  document.getElementById('stageCompleteOverlay').classList.add('show');
  spawnConfetti();
  speak(`Stage complete. You scored ${pct} percent.`);
}

function nextStage() {
  document.getElementById('stageCompleteOverlay').classList.remove('show');
  stageIndex++;
  if (selectedMode === 'training') loadStage();
  else loadQuizStage();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   SPEECH & EFFECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function speak(text) {
  if(!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.0;
  speechSynthesis.speak(utterance);
}

function spawnConfetti() {
  const canvas = document.getElementById('confettiCanvas');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const colors = ['#f0b429','#4d9eff','#c084fc','#22d37a','#ff8500','#fff'];
  const pts = Array.from({length:100},()=>({
    x:Math.random()*canvas.width, y:-20-Math.random()*200,
    r:3+Math.random()*6, speed:1.2+Math.random()*2.5,
    color:colors[Math.floor(Math.random()*colors.length)],
    angle:Math.random()*Math.PI*2,
  }));
  let f=0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pts.forEach(p=>{p.y+=p.speed;p.x+=Math.sin(p.angle+=0.04)*1.5;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=p.color;ctx.fill();});
    if(++f<200) requestAnimationFrame(draw); else ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  draw();
}
</script>
</body>
</html>
